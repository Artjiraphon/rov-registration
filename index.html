<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ROV DREAM WAR – Registration (Pipedream)</title>
<style>
  :root{
    --bg-url: url("https://lh3.googleusercontent.com/d/1WcRXfA9bcbG3o6UFt1OsvjDOGiVoTa8I");
    --logo-url: url("https://lh3.googleusercontent.com/d/1CwHuiswWfbkS8Ncz_5MnPmJ3oDgvWbJ_");
    --btn-from:#8e0e0e; --btn-to:#c91919;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',Arial,sans-serif;background:#000;color:#0d1b2a;}
  body{display:flex;align-items:center;justify-content:center;}
  .stage{position:relative;max-width:100vw; max-height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden;}
  .bg{max-width:100vw; max-height:100vh; width:auto; height:auto; object-fit:contain; display:block;}
  .overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;}
  .stack{pointer-events:auto; display:flex; flex-direction:column; align-items:center; max-height:90%; overflow:auto; padding:8px 12px;}
  .brand{width:min(28vw, 220px); height:auto; aspect-ratio: 220/96; background:var(--logo-url) center/contain no-repeat; transform: translateY(-20%); margin-bottom: 8px; filter: drop-shadow(0 2px 8px rgba(0,0,0,.25));}
  .card{width:min(448px, 69vw); background:rgba(255,255,255,.92); backdrop-filter:blur(6px); border-radius:20px; box-shadow:0 12px 30px rgba(0,0,0,.25); padding:18px;}
  .title{font-weight:800;text-align:center;margin:0 0 8px;font-size:18px;}
  .grid{display:grid;gap:10px;}
  .pill{height:54px;border:none;border-radius:999px;background:#fff; padding:0 16px;box-shadow:0 8px 20px rgba(0,0,0,.18); font-size:16px;outline:none;}
  .pill:focus{box-shadow:0 0 0 3px rgba(201,25,25,.18),0 8px 20px rgba(0,0,0,.18);}
  .btn{display:inline-block;padding:12px 22px;border-radius:999px;font-weight:700;border:0;cursor:pointer;}
  .btn-primary{color:#fff;background:linear-gradient(to bottom,var(--btn-from),var(--btn-to));box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .btn-outline{background:#fff;color:#b21515;border:2px solid #b21515;}
  .row{display:flex;justify-content:space-between;gap:12px;margin-top:12px;}
  .err{color:#d90429;font-size:13px;margin-top:-6px}
  .muted{color:#6b7280;font-size:13px}
  .center{text-align:center}
  .progress{font-size:13px;color:#6b7280;text-align:center;margin-top:6px}
  .hidden{display:none!important}
  @media (max-height:640px){ .brand{ transform: translateY(-10%); width:min(32vw, 180px); } .stack{ max-height:88%; } }
  .cta-link{ color:#000; font-weight:700; text-decoration:underline; cursor:pointer; }
  .cta-link:hover{ text-decoration:none; opacity:.85; }
  .cta-row{ margin:8px 0 6px; }
  .pdf-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .pdf-modal{width:min(1100px,92vw);height:min(90vh,820px);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
  .pdf-modal header{height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:#111827;color:#fff}
  .pdf-modal header .title{margin:0;font-size:15px;font-weight:800;color:#fff}
  .pdf-modal header .actions{display:flex;gap:8px}
  .iconbtn{border:0;background:#374151;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .iconbtn:hover{filter:brightness(1.05)}
  .pdf-modal .frame{width:100%;height:calc(100% - 52px);border:0}
  .radio-row{background:#fff;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.18);padding:12px 16px}
</style>
</head>
<body>

  <div class="stage">
    <img id="bg" class="bg" alt="background"/>
    <div class="overlay">
      <div class="stack">
        <div class="brand"></div>

        <!-- Step 1 -->
        <section class="card" id="step1">
          <h2 class="title">ข้อมูลผู้ลงทะเบียน</h2>
          <div class="grid">
            <input id="phone" class="pill" placeholder="กรอกเบอร์โทรศัพท์ (10 หลัก)" inputmode="numeric" />
            <div id="errPhone" class="err hidden">กรุณากรอกเบอร์ให้ครบ 10 หลัก</div>
            <input id="email" class="pill" type="email" placeholder="กรอกอีเมล" />
            <div id="errEmail" class="err hidden">อีเมลไม่ถูกต้อง</div>
          </div>

          <p class="cta-row">
            <span class="cta-link"
              onclick="pdfModalOpen('https://drive.google.com/file/d/1kl8gDxe9jqGYZBN0xZDtAjeYAMW1OnvB/preview','ข้อมูล PDPA')">
              โปรดอ่านข้อมูลรายละเอียดเพิ่มเติม
            </span>
          </p>
          <label style="display:block;margin-top:6px">
            <input type="checkbox" id="agreePdpa"> ยินยอมตาม PDPA สำหรับกิจกรรมนี้เท่านั้น
          </label>
          <div id="errAgreePdpa" class="err hidden">กรุณายอมรับ PDPA ก่อนดำเนินการต่อ</div>

          <div class="center" style="margin-top:12px">
            <button class="btn btn-primary" id="next1">SUBMIT</button>
          </div>
        </section>

        <!-- Step 2 -->
        <section class="card hidden" id="step2">
          <h2 class="title">โปรดอ่านรายละเอียดข้อมูลการลงทะเบียน</h2>
          <div class="grid">
            <ul class="muted" style="line-height:1.6">
              <li>ผู้เข้าร่วมกิจกรรมสงวนสิทธิ์สำหรับพนักงานบริษัทเท่านั้น</li>
              <li>แข่งขันประเภททีม 5 คน + สำรอง 1 คน รวม 6 คน</li>
              <li>สมาชิกแต่ละทีมต้องมาจากมากกว่า 1 แผนก</li>
              <li>ต้องกรอกรายละเอียดให้ครบถ้วนเพื่อสมัครเข้าร่วม</li>
            </ul>

            <p class="cta-row">
              <span class="cta-link"
                onclick="pdfModalOpen('https://drive.google.com/file/d/1Oav59tc-LOU4MT19GVWPgF6_kJM3SXK3/preview','ROV RULE BOOK')">
                โปรดอ่านข้อมูลรายละเอียดเพิ่มเติม
              </span>
            </p>

            <label><input type="checkbox" id="agree"> ยอมรับกฎ กติกา การแข่งขัน</label>
            <div id="errAgree" class="err hidden">กรุณายอมรับกติกาก่อนดำเนินการต่อ</div>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="back2">BACK</button>
            <button class="btn btn-primary" id="next2">SUBMIT</button>
          </div>
        </section>

        <!-- Step 3 -->
        <section class="card hidden" id="step3">
          <h2 class="title">โปรดระบุชื่อทีมที่จะใช้ในการแข่งขัน</h2>
          <input id="team" class="pill" placeholder="ชื่อทีม (2–20 ตัวอักษร)" />
          <div id="errTeam" class="err hidden">กรุณากรอกชื่อทีม 2–20 ตัวอักษร</div>
          <div class="row">
            <button class="btn btn-outline" id="back3">BACK</button>
            <button class="btn btn-primary" id="next3">NEXT</button>
          </div>
        </section>

        <!-- Step 4: Player details (with shuttle) -->
        <section class="card hidden" id="step4">
          <h2 class="title">ข้อมูลส่วนบุคคล ผู้เล่นคนที่ <span id="pIndex">1</span></h2>
          <div class="grid">
            <input id="pName"  class="pill" placeholder="ชื่อ–นามสกุล" />
            <input id="pEmpId" class="pill" placeholder="รหัสพนักงาน" />
            <input id="pDept"  class="pill" placeholder="ฝ่าย" />
            <input id="pTel"   class="pill" placeholder="เบอร์โทรศัพท์ (10 หลัก)" inputmode="numeric" />
            <select id="pShirt" class="pill">
              <option value="">ขนาดไซส์เสื้อ แข่งขัน</option>
              <option>S (รอบอก 38 นิ้ว)</option><option>M (รอบอก 40 นิ้ว)</option><option>L (รอบอก 42 นิ้ว)</option>
              <option>XL (รอบอก 44 นิ้ว)</option><option>2XL (รอบอก 46 นิ้ว)</option><option>3XL (รอบอก 48 นิ้ว)</option>
            </select>

            <!-- Shuttle options for EVERY player -->
            <div class="radio-row">
              <strong>รถรับส่ง</strong><br>
              <label><input type="radio" name="pShuttle" value="yes"> ต้องการรถรับส่ง</label>
              &nbsp;&nbsp;
              <label><input type="radio" name="pShuttle" value="no"> ไม่ต้องการรถรับส่ง</label>
              <div class="muted">ต้องเลือก "ต้องการ" ก่อน จึงจะเลือกสายรถได้</div>
            </div>
            <select id="pRoute" class="pill hidden">
              <option value="">เลือกสายรถ</option>
              <option value="1">เส้นทางที่ 1 เทคโนโลยีสมุทรปราการ</option>
              <option value="2">เส้นทางที่ 2 พระประแดง</option>
              <option value="3">เส้นทางที่ 3 อนุสาวรีย์</option>
              <option value="4">เส้นทางที่ 4 บางขุนเทียน</option>
              <option value="5">เส้นทางที่ 5 หนองจอก</option>
            </select>
            <input id="pDrop" class="pill hidden" placeholder="จุดส่ง (โปรดระบุ)">

            <div id="errPlayer" class="err hidden">กรอกข้อมูลให้ครบทุกช่อง และเบอร์ 10 หลัก (ถ้าเลือกต้องการรถรับส่ง ต้องเลือกสายรถด้วย)</div>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="back4">BACK</button>
            <div>
              <button class="btn btn-outline" id="prevP">Prev</button>
              <button class="btn btn-primary" id="nextP">NEXT</button>
              <button class="btn btn-primary hidden" id="submitAll">SUBMIT</button>
            </div>
          </div>
          <div class="progress">Player <span id="pProg">1</span> / 6</div>
        </section>

        <!-- Step 5 -->
        <section class="card hidden" id="step5">
          <div style="padding:8px 6px 2px">
            <h1 style="margin:0;font-size:64px;font-weight:1000;color:#d02020;text-align:center;letter-spacing:.5px">
              ลงทะเบียนสำเร็จ
            </h1>
            <h2 style="margin:14px 0 26px;font-size:40px;font-weight:900;text-align:center;color:#111">
              ขอบคุณที่ท่านตอบรับเข้าร่วมกิจกรรม
            </h2>
            <p style="font-size:28px;text-align:center;color:#111;margin:12px 0">หากต้องการสอบถามข้อมูลเพิ่มเติม</p>
            <p style="font-size:28px;text-align:center;color:#111;margin:4px 0">กรุณาติดต่อ บริษัท ลิงก์โร้ดทราเวล จำกัด</p>
            <p style="font-size:40px;text-align:center;margin:10px 0 4px;font-weight:900">096–750–5993</p>
            <div style="text-align:center;margin-top:18px">
              <button class="btn btn-outline" id="restart" type="button">เริ่มใหม่</button>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- PDF Modal -->
  <div class="pdf-modal-backdrop" id="pdfModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
    <div class="pdf-modal" role="document">
      <header>
        <div class="title" id="pdfModalTitle">PDF</div>
        <div class="actions">
          <a id="pdfOpenNewTab" class="iconbtn" target="_blank" rel="noopener">เปิดแท็บใหม่</a>
          <button type="button" class="iconbtn" onclick="pdfModalClose()">ปิด</button>
        </div>
      </header>
      <iframe id="pdfFrame" class="frame" src=""></iframe>
    </div>
  </div>

<script>
(function setBgFromVar(){
  var v = getComputedStyle(document.documentElement).getPropertyValue('--bg-url').trim();
  if(v.startsWith('url(')) v = v.slice(4, -1).replace(/^"|"$/g,'');
  document.getElementById('bg').src = v;
})();

var storageKey = 'rov-dreamwar-pd';
var init = {
  phone:'', email:'', agree:false, team:'',
  players: (function(){var a=[]; for(var i=0;i<6;i++){a.push({name:'',empId:'',dept:'',tel:'',shirt:'', shuttle:'', route:'', drop:''});} return a;})()
};
var data = load() || JSON.parse(JSON.stringify(init));
var step = 1, pi = 0;

function save(){ localStorage.setItem(storageKey, JSON.stringify(data)); }
function load(){ try{ return JSON.parse(localStorage.getItem(storageKey)); }catch(e){ return null; } }
function qs(id){ return document.getElementById(id); }
function show(id){ ['step1','step2','step3','step4','step5'].forEach(s=>qs(s).classList.add('hidden')); qs(id).classList.remove('hidden'); }
function isPhone10(v){ return /^\d{10}$/.test(String(v||'').trim()); }
function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }
function vStep1(){ var okP=isPhone10(qs('phone').value), okE=isEmail(qs('email').value); qs('errPhone').classList.toggle('hidden',okP); qs('errEmail').classList.toggle('hidden',okE); return okP&&okE; }
function vStep2(){ var ok=qs('agree').checked; qs('errAgree').classList.toggle('hidden',ok); return ok; }
function vStep3(){ var t=qs('team').value.trim(); var ok=t.length>=2&&t.length<=20; qs('errTeam').classList.toggle('hidden',ok); return ok; }
function vPlayer(){
  var baseOk = qs('pName').value && qs('pEmpId').value && qs('pDept').value && isPhone10(qs('pTel').value) && qs('pShirt').value;
  var shuttle = document.querySelector('input[name="pShuttle"]:checked');
  var needRoute = shuttle && shuttle.value==='yes';
  var routeOk = !needRoute || !!qs('pRoute').value;
  var ok = baseOk && routeOk;
  qs('errPlayer').classList.toggle('hidden', ok);
  return ok;
}
function syncFromState(){
  qs('phone').value=data.phone; qs('email').value=data.email;
  qs('agree').checked=!!data.agree;
  qs('team').value=data.team;
  var p=data.players[pi];
  qs('pIndex').textContent=(pi+1); qs('pProg').textContent=(pi+1);
  qs('pName').value=p.name; qs('pEmpId').value=p.empId; qs('pDept').value=p.dept; qs('pTel').value=p.tel; qs('pShirt').value=p.shirt;
  // shuttle
  document.querySelectorAll('input[name="pShuttle"]').forEach(r=>r.checked=false);
  if(p.shuttle){ var r=document.querySelector('input[name="pShuttle"][value="'+p.shuttle+'"]'); if(r) r.checked=true; }
  qs('pRoute').value=p.route||"";
  qs('pDrop').value=p.drop||"";
  toggleShuttleUI();
  qs('nextP').classList.toggle('hidden',pi===5); qs('submitAll').classList.toggle('hidden',pi!==5);
}
function collectStep1(){ data.phone=qs('phone').value.replace(/[^\d]/g,''); data.email=qs('email').value.trim(); save(); }
function collectStep2(){ data.agree=qs('agree').checked; save(); }
function collectStep3(){ data.team=qs('team').value.trim(); save(); }
function collectPlayer(){ var p=data.players[pi]; p.name=qs('pName').value.trim(); p.empId=qs('pEmpId').value.trim(); p.dept=qs('pDept').value.trim(); p.tel=qs('pTel').value.replace(/[^\d]/g,''); p.shirt=qs('pShirt').value; var sh=document.querySelector('input[name="pShuttle"]:checked'); p.shuttle=sh?sh.value:''; p.route=qs('pRoute').value; p.drop=qs('pDrop').value.trim(); save(); }

qs('next1').onclick=function(){
  collectStep1();
  var okPdpa = qs('agreePdpa') && qs('agreePdpa').checked;
  if(!okPdpa){ qs('errAgreePdpa').classList.remove('hidden'); return; }
  if(!vStep1()) return;
  step=2; show('step2'); syncFromState();
};
qs('back2').onclick=function(){ step=1; show('step1'); syncFromState(); };
qs('next2').onclick=function(){ collectStep2(); if(!vStep2()) return; step=3; show('step3'); syncFromState(); };
qs('back3').onclick=function(){ step=2; show('step2'); syncFromState(); };
qs('next3').onclick=function(){ collectStep3(); if(!vStep3()) return; step=4; show('step4'); syncFromState(); };
qs('back4').onclick=function(){ step=3; show('step3'); syncFromState(); };
qs('prevP').onclick=function(){ collectPlayer(); if(pi>0) pi--; syncFromState(); };
qs('nextP').onclick=function(){ collectPlayer(); if(!vPlayer()) return; if(pi<5) pi++; syncFromState(); };

// shuttle UI toggle + listeners
function toggleShuttleUI(){
  const yes = (document.querySelector('input[name="pShuttle"][value="yes"]')||{}).checked;
  const dd  = qs('pRoute');
  const dp  = qs('pDrop');
  if(!dd||!dp) return;
  if (yes) { dd.classList.remove('hidden'); dp.classList.remove('hidden'); }
  else { dd.classList.add('hidden'); dp.classList.add('hidden'); dd.value=''; dp.value=''; }
}

document.querySelectorAll('input[name="pShuttle"]').forEach(el=>{
  el.addEventListener('change', toggleShuttleUI);
});

/* ========= ส่งไป Pipedream ========= */
const API_URL = "https://eoo8xm8tmmi51xn.m.pipedream.net";

qs('submitAll').onclick = async function(){
  collectPlayer();
  if(!vPlayer()) return;

  var allOk = data.players.every(p => p.name && p.empId && p.dept && isPhone10(p.tel) && p.shirt && (p.shuttle!=='yes' || !!p.route));
  if(!allOk){ qs('errPlayer').classList.remove('hidden'); return; }

  var payload = {
    timestamp: new Date().toISOString(),
    phone: data.phone,
    email: data.email,
    team:  data.team,
    agree: !!data.agree,
    players: data.players.map(p => ({name:p.name, empId:p.empId, dept:p.dept, tel:p.tel, shirt:p.shirt, shuttle:p.shuttle, route:p.route, drop:p.drop}))
  };

  disableButtons(true);
  try{
    console.log("ส่งไป Pipedream:", payload);
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('HTTP '+res.status);

    localStorage.removeItem(storageKey);
    step=5; show('step5');
  }catch(err){
    alert('ส่งไม่สำเร็จ: ' + (err && err.message ? err.message : err));
  }finally{
    disableButtons(false);
  }
};

qs('restart').onclick=function(){
  localStorage.removeItem(storageKey);
  data = JSON.parse(JSON.stringify(init));
  step=1; pi=0; show('step1'); syncFromState();
};

function disableButtons(disabled){
  document.querySelectorAll('button').forEach(b=>b.disabled=!!disabled);
}

/* ---------- init ---------- */
(function initUI(){
  qs('phone').addEventListener('input', function(e){ e.target.value = e.target.value.replace(/[^\d]/g,''); });
  qs('pTel').addEventListener('input', function(e){ e.target.value = e.target.value.replace(/[^\d]/g,''); });

  show('step1');
  syncFromState();
})();

/* ========================= Modal PDF ========================= */
(function(){
  var backdrop = document.getElementById('pdfModalBackdrop');
  if(!backdrop) return;
  var frame = document.getElementById('pdfFrame');
  var openNewTab = document.getElementById('pdfOpenNewTab');
  var lastActive = null;

  window.pdfModalOpen = function(url, title){
    var t = document.getElementById('pdfModalTitle');
    if(t) t.textContent = title || 'PDF';
    frame.src = url;
    if(openNewTab) openNewTab.href = url.replace('/preview','/view');
    lastActive = document.activeElement;
    backdrop.style.display = 'flex';
    document.addEventListener('keydown', escClose, { once:true });
  };
  window.pdfModalClose = function(){
    backdrop.style.display = 'none';
    frame.src = '';
    if(lastActive && lastActive.focus) lastActive.focus();
  };
  function escClose(e){ if(e.key === 'Escape') window.pdfModalClose(); }
  backdrop.addEventListener('click', function(e){ if(e.target === backdrop) window.pdfModalClose(); });
})();

/* บังคับติ๊ก PDPA ก่อนกด SUBMIT ใน Step 1 */
(function(){
  var btn = document.getElementById('next1');
  if(!btn) return;
  var original = btn.onclick;
  btn.onclick = function(){
    var ok = document.getElementById('agreePdpa') && document.getElementById('agreePdpa').checked;
    if(!ok){
      var err = document.getElementById('errAgreePdpa');
      if(err) err.classList.remove('hidden');
      return;
    }
    if(original) original();
  };
})();
</script>
</body>
</html>