<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ROV DREAM WAR – Registration (Baserow)</title>
<style>
  :root{
  /* ใช้ลิงก์ฝังของ Google Drive (ต้องตั้งแชร์เป็น Anyone with the link) */
  --bg-url: url("https://drive.google.com/uc?export=view&id=1WcRXfA9bcbG3o6UFt1OsvjDOGiVoTa8I");
  --logo-url: url("https://drive.google.com/uc?export=view&id=1CwHuiswWfbkS8Ncz_5MnPmJ3oDgvWbJ_");
  --btn-from:#8e0e0e; --btn-to:#c91919;
  }

  /* หน้าดำ ล้อมภาพไว้ และจัดกึ่งกลางทั้งแนวตั้ง/แนวนอน */
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',Arial,sans-serif;background:#000;color:#0d1b2a;}
  body{display:flex;align-items:center;justify-content:center;}

  /* กล่องเวที = ขนาดเท่ากับรูปพื้นหลังที่ย่อแบบ contain */
  .stage{
    position:relative;
    max-width:100vw; max-height:100vh;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden; /* กัน UI ล้นออกนอกภาพ */
  }
  .bg{
    max-width:100vw; max-height:100vh;
    width:auto; height:auto;
    object-fit:contain; display:block;
  }

  /* ชั้นซ้อนบนภาพ: รวมโลโก้ + การ์ดฟอร์ม ให้อยู่กลางภาพ */
  .overlay{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;             /* ให้คลิกทะลุ ยกเว้นภายในกล่อง */
  }
  .stack{
    pointer-events:auto;             /* เปิดคลิกเฉพาะใน UI */
    display:flex; flex-direction:column; align-items:center;
    max-height:90%;                  /* ถ้าจอเตี้ยมาก ให้ UI ไม่ชนขอบภาพ */
    overflow:auto;
    padding:8px 12px;
  }

  /* โลโก้กลาง และยกขึ้น 20% ให้ชิดการ์ดมากขึ้น */
  .brand{
    width:min(28vw, 220px);          /* โตตามหน้าจอ แต่มีเพดาน */
    height:auto; aspect-ratio: 220/96;
    background:var(--logo-url) center/contain no-repeat;
    transform: translateY(-20%);     /* ยกขึ้น 20% */
    margin-bottom: 8px;              /* ชิดการ์ด */
    filter: drop-shadow(0 2px 8px rgba(0,0,0,.25));
  }

  /* การ์ดฟอร์ม */
  .card{
    width:min(448px, 69vw);
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(6px);
    border-radius:20px;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    padding:18px;
  }

  .title{font-weight:800;text-align:center;margin:0 0 8px;font-size:18px;}
  .grid{display:grid;gap:10px;}
  .pill{
    height:54px;border:none;border-radius:999px;background:#fff;
    padding:0 16px;box-shadow:0 8px 20px rgba(0,0,0,.18);
    font-size:16px;outline:none;
  }
  .pill:focus{box-shadow:0 0 0 3px rgba(201,25,25,.18),0 8px 20px rgba(0,0,0,.18);}
  .btn{display:inline-block;padding:12px 22px;border-radius:999px;font-weight:700;border:0;cursor:pointer;}
  .btn-primary{color:#fff;background:linear-gradient(to bottom,var(--btn-from),var(--btn-to));box-shadow:0 10px 24px rgba(0,0,0,.25);}
  .btn-outline{background:#fff;color:#b21515;border:2px solid #b21515;}
  .row{display:flex;justify-content:space-between;gap:12px;margin-top:12px;}
  .err{color:#d90429;font-size:13px;margin-top:-6px}
  .muted{color:#6b7280;font-size:13px}
  .center{text-align:center}
  .progress{font-size:13px;color:#6b7280;text-align:center;margin-top:6px}
  .hidden{display:none!important}
  .success{color:#0a7a30;font-weight:800;font-size:20px}

  /* มือถือเตี้ยมาก: บีบโลโก้ลงเล็กน้อย */
  @media (max-height:640px){
    .brand{ transform: translateY(-10%); width:min(32vw, 180px); }
    .stack{ max-height:88%; }
  }

  /* =========================[ADD ONLY]========================= */
  /* ลิงก์ดำเส้นใต้ (ตำแหน่งตามรูปไกด์) */
  .cta-link{ color:#000; font-weight:700; text-decoration:underline; cursor:pointer; }
  .cta-link:hover{ text-decoration:none; opacity:.85; }
  .cta-row{ margin:8px 0 6px; }

  /* Modal PDF */
  .pdf-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
  .pdf-modal{width:min(1100px,92vw);height:min(90vh,820px);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);overflow:hidden}
  .pdf-modal header{height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:#111827;color:#fff}
  .pdf-modal header .title{margin:0;font-size:15px;font-weight:800;color:#fff}
  .pdf-modal header .actions{display:flex;gap:8px}
  .iconbtn{border:0;background:#374151;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .iconbtn:hover{filter:brightness(1.05)}
  .pdf-modal .frame{width:100%;height:calc(100% - 52px);border:0}
  /* =======================[/ADD ONLY]========================= */
</style>
</head>
<body>

  <!-- เวที: รูปพื้นหลังแบบ <img> (contain) + ชั้น overlay ของ UI -->
  <div class="stage">
    <!-- พื้นหลังเป็นรูปจริง => UI จะไม่ล้นออกนอกภาพ -->
    <img id="bg" class="bg" alt="background"/>

    <!-- UI กลางภาพ -->
    <div class="overlay">
      <div class="stack">
        <div class="brand"></div>

        <!-- Step 1 -->
        <section class="card" id="step1">
          <h2 class="title">ข้อมูลผู้ลงทะเบียน</h2>
          <div class="grid">
            <input id="phone" class="pill" placeholder="กรอกเบอร์โทรศัพท์ (10 หลัก)" inputmode="numeric" />
            <div id="errPhone" class="err hidden">กรุณากรอกเบอร์ให้ครบ 10 หลัก</div>
            <input id="email" class="pill" type="email" placeholder="กรอกอีเมล" />
            <div id="errEmail" class="err hidden">อีเมลไม่ถูกต้อง</div>
          </div>

          <!-- ลิงก์ดำเส้นใต้ + ป๊อปอัป PDF (PDPA) -->
          <p class="cta-row">
            <span class="cta-link"
              onclick="pdfModalOpen('https://drive.google.com/file/d/1kl8gDxe9jqGYZBN0xZDtAjeYAMW1OnvB/preview','ข้อมูล PDPA')">
              โปรดอ่านข้อมูลรายละเอียดเพิ่มเติม
            </span>
          </p>
          <!-- Checkbox ยอมรับ PDPA ก่อน Submit -->
          <label style="display:block;margin-top:6px">
            <input type="checkbox" id="agreePdpa"> ผู้ลงทะเบียนได้อ่าน และยินยอม ในการให้ข้อมูล ชื่อ นามสกุล เบอร์ติดต่อ และ EMAIL เพื่อใช้ในการสื่อสาร ในการสมัครร่วมกิจกรรมครั้งนี้เท่านั้น
          </label>
          <div id="errAgreePdpa" class="err hidden">กรุณายอมรับ PDPA ก่อนดำเนินการต่อ</div>

          <div class="center" style="margin-top:12px">
            <button class="btn btn-primary" id="next1">SUBMIT</button>
          </div>
        </section>

        <!-- Step 2 -->
        <section class="card hidden" id="step2">
          <h2 class="title">โปรดอ่านรายละเอียดข้อมูลการลงทะเบียน</h2>
          <div class="grid">
            <ul class="muted" style="line-height:1.6">
              <li>ผู้เข้าร่วมกิจกรรมสงวนสิทธิ์สำหรับพนักงานบริษัทเท่านั้น</li>
              <li>แข่งขันประเภททีม 5 คน + สำรอง 1 คน รวม 6 คน</li>
              <li>สมาชิกแต่ละทีมต้องมาจากมากกว่า 1 แผนก</li>
              <li>ต้องกรอกรายละเอียดให้ครบถ้วนเพื่อสมัครเข้าร่วม</li>
            </ul>

            <!-- RULE BOOK -->
            <p class="cta-row">
              <span class="cta-link"
                onclick="pdfModalOpen('https://drive.google.com/file/d/1ennXoGAjb-2Cydh5GgF_lp0RaKKmln_d/preview','ROV RULE BOOK')">
                โปรดอ่านข้อมูลรายละเอียดเพิ่มเติม
              </span>
            </p>

            <label><input type="checkbox" id="agree"> ผู้ลงทะเบียนได้อ่าน และยอมรับในกฎ กติกา การแข่งขัน</label>
            <div id="errAgree" class="err hidden">กรุณายอมรับกติกาก่อนดำเนินการต่อ</div>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="back2">BACK</button>
            <button class="btn btn-primary" id="next2">SUBMIT</button>
          </div>
        </section>

        <!-- Step 3 -->
        <section class="card hidden" id="step3">
          <h2 class="title">โปรดระบุชื่อทีมที่จะใช้ในการแข่งขัน</h2>
          <input id="team" class="pill" placeholder="ชื่อทีม (2–20 ตัวอักษร)" />
          <div id="errTeam" class="err hidden">กรุณากรอกชื่อทีม 2–20 ตัวอักษร</div>
          <div class="row">
            <button class="btn btn-outline" id="back3">BACK</button>
            <button class="btn btn-primary" id="next3">NEXT</button>
          </div>
        </section>

        <!-- Step 4 -->
        <section class="card hidden" id="step4">
          <h2 class="title">ข้อมูลส่วนบุคคล ผู้เล่นคนที่ <span id="pIndex">1</span></h2>
          <div class="grid">
            <input id="pName"  class="pill" placeholder="ชื่อ–นามสกุล" />
            <input id="pEmpId" class="pill" placeholder="รหัสพนักงาน" />
            <input id="pDept"  class="pill" placeholder="แผนก" />
            <input id="pTel"   class="pill" placeholder="เบอร์โทรศัพท์ (10 หลัก)" inputmode="numeric" />
            <select id="pShirt" class="pill">
              <option value="">ขนาดไซส์เสื้อ แข่งขัน</option>
              <option>S</option><option>M</option><option>L</option>
              <option>XL</option><option>2XL</option><option>3XL</option>
            </select>
            <div id="errPlayer" class="err hidden">กรอกข้อมูลให้ครบทุกช่อง และเบอร์ 10 หลัก</div>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="back4">BACK</button>
            <div>
              <button class="btn btn-outline" id="prevP">Prev</button>
              <button class="btn btn-primary" id="nextP">NEXT</button>
              <button class="btn btn-primary hidden" id="submitAll">SUBMIT</button>
            </div>
          </div>
          <div class="progress">Player <span id="pProg">1</span> / 6</div>
        </section>

        <!-- Step 5 -->
        <section class="card hidden" id="step5">
          <div style="padding:8px 6px 2px">
            <h1 style="margin:0;font-size:64px;font-weight:1000;color:#d02020;text-align:center;letter-spacing:.5px">
              ลงทะเบียนสำเร็จ
            </h1>
            <h2 style="margin:14px 0 26px;font-size:40px;font-weight:900;text-align:center;color:#111">
              ขอบคุณที่ท่านตอบรับเข้าร่วมกิจกรรม
            </h2>

            <p style="font-size:28px;text-align:center;color:#111;margin:12px 0">
              หากต้องการสอบถามข้อมูลเพิ่มเติม
            </p>
            <p style="font-size:28px;text-align:center;color:#111;margin:4px 0">
              กรุณาติดต่อ บริษัท ลิงก์โร้ดทราเวล จำกัด
            </p>
            <p style="font-size:40px;text-align:center;margin:10px 0 4px;font-weight:900">
              096–750–5993
            </p>

            <div style="text-align:center;margin-top:18px">
              <button class="btn btn-outline" id="restart" type="button">เริ่มใหม่</button>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- Modal ป๊อปอัป PDF -->
  <div class="pdf-modal-backdrop" id="pdfModalBackdrop" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
    <div class="pdf-modal" role="document">
      <header>
        <div class="title" id="pdfModalTitle">PDF</div>
        <div class="actions">
          <a id="pdfOpenNewTab" class="iconbtn" target="_blank" rel="noopener">เปิดแท็บใหม่</a>
          <button type="button" class="iconbtn" onclick="pdfModalClose()">ปิด</button>
        </div>
      </header>
      <iframe id="pdfFrame" class="frame" src=""></iframe>
    </div>
  </div>

<script>
/* ---------- ตั้งรูป bg จากตัวแปร CSS ---------- */
(function setBgFromVar(){
  var v = getComputedStyle(document.documentElement).getPropertyValue('--bg-url').trim();
  if(v.startsWith('url(')) v = v.slice(4, -1).replace(/^"|"$/g,'');
  document.getElementById('bg').src = v;
})();

/* ---------- simple state + autosave ---------- */
var storageKey = 'rov-dreamwar-baserow';
var init = {
  phone:'', email:'', agree:false, team:'',
  players: (function(){var a=[]; for(var i=0;i<6;i++){a.push({name:'',empId:'',dept:'',tel:'',shirt:''});} return a;})()
};
var data = load() || JSON.parse(JSON.stringify(init));
var step = 1;
var pi = 0; // player index 0..5

function save(){ localStorage.setItem(storageKey, JSON.stringify(data)); }
function load(){ try{ return JSON.parse(localStorage.getItem(storageKey)); }catch(e){ return null; } }
function qs(id){ return document.getElementById(id); }
function show(id){
  var ids = ['step1','step2','step3','step4','step5'];
  for(var i=0;i<ids.length;i++){ qs(ids[i]).classList.add('hidden'); }
  qs(id).classList.remove('hidden');
}

/* ---------- validators ---------- */
function isPhone10(v){ return /^\\d{10}$/.test(String(v||'').trim()); }
function isEmail(v){ return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(String(v||'').trim()); }
function vStep1(){
  var okP = isPhone10(qs('phone').value);
  var okE = isEmail(qs('email').value);
  qs('errPhone').classList.toggle('hidden', okP);
  qs('errEmail').classList.toggle('hidden', okE);
  return okP && okE;
}
function vStep2(){
  var ok = qs('agree').checked;
  qs('errAgree').classList.toggle('hidden', ok);
  return ok;
}
function vStep3(){
  var t = qs('team').value.trim();
  var ok = t.length>=2 && t.length<=20;
  qs('errTeam').classList.toggle('hidden', ok);
  return ok;
}
function vPlayer(){
  var ok = qs('pName').value && qs('pEmpId').value && qs('pDept').value &&
           isPhone10(qs('pTel').value) && qs('pShirt').value;
  qs('errPlayer').classList.toggle('hidden', ok);
  return ok;
}

/* ---------- bind inputs to state ---------- */
function syncFromState(){
  // step1
  qs('phone').value = data.phone; qs('email').value = data.email;
  // step2
  qs('agree').checked = !!data.agree;
  // step3
  qs('team').value = data.team;
  // step4 current player
  var p = data.players[pi];
  qs('pIndex').textContent = (pi+1);
  qs('pProg').textContent = (pi+1);
  qs('pName').value = p.name; qs('pEmpId').value = p.empId; qs('pDept').value = p.dept;
  qs('pTel').value = p.tel; qs('pShirt').value = p.shirt;
  // toggle submit/show
  qs('nextP').classList.toggle('hidden', pi===5);
  qs('submitAll').classList.toggle('hidden', pi!==5);
}
function collectStep1(){ data.phone = qs('phone').value.replace(/[^\\d]/g,''); data.email = qs('email').value.trim(); save(); }
function collectStep2(){ data.agree = qs('agree').checked; save(); }
function collectStep3(){ data.team  = qs('team').value.trim(); save(); }
function collectPlayer(){
  var p = data.players[pi];
  p.name = qs('pName').value.trim();
  p.empId= qs('pEmpId').value.trim();
  p.dept = qs('pDept').value.trim();
  p.tel  = qs('pTel').value.replace(/[^\\d]/g,'');
  p.shirt= qs('pShirt').value;
  save();
}

/* ---------- nav ---------- */
qs('next1').onclick = function(){
  collectStep1();
  var ok = document.getElementById('agreePdpa') && document.getElementById('agreePdpa').checked;
  if(!ok){
    var err = document.getElementById('errAgreePdpa');
    if(err) err.classList.remove('hidden');
    return;
  }
  if(!vStep1()) return;
  step=2; show('step2'); syncFromState();
};
qs('back2').onclick = function(){ step=1; show('step1'); syncFromState(); };
qs('next2').onclick = function(){
  collectStep2();
  if(!vStep2()) return;
  step=3; show('step3'); syncFromState();
};
qs('back3').onclick = function(){ step=2; show('step2'); syncFromState(); };
qs('next3').onclick = function(){
  collectStep3();
  if(!vStep3()) return;
  step=4; show('step4'); syncFromState();
};
qs('back4').onclick = function(){ step=3; show('step3'); syncFromState(); };

qs('prevP').onclick = function(){
  collectPlayer();
  if(pi>0) pi--; syncFromState();
};
qs('nextP').onclick = function(){
  collectPlayer();
  if(!vPlayer()) return;
  if(pi<5) pi++; syncFromState();
};

/* ========= ส่งไป BASEROW (แทนที่ Google Apps Script/Pipedream) ========= */
const BASEROW_API="https://api.baserow.io/api/database/rows/table/663776/?user_field_names=true";
const BASEROW_TOKEN="SPf8E23TlwU5EY3tXLfLXbiySRPcVpSz"; /* <- ใส่โทเคนจริงของคุณ */

qs('submitAll').onclick = async function(){
  collectPlayer();
  if(!vPlayer()) return;

  // ตรวจครบทั้ง 6 คน
  var allOk = true;
  for(var k=0;k<6;k++){
    var x = data.players[k];
    if(!(x.name && x.empId && x.dept && isPhone10(x.tel) && x.shirt)){ allOk=false; break; }
  }
  if(!allOk){ qs('errPlayer').classList.remove('hidden'); return; }

  // flatten payload ให้เข้ากับ schema ที่คล้าย Google Sheet เดิม
  var out = {
    timestamp: new Date().toISOString(),
    phone: data.phone,
    email: data.email,
    team_name: data.team,
    agree: !!data.agree
  };
  for(var i=0;i<6;i++){
    var p = data.players[i];
    var n = i+1;
    out['p'+n+'_name'] = p.name;
    out['p'+n+'_emp_id'] = p.empId;
    out['p'+n+'_dept'] = p.dept;
    out['p'+n+'_phone'] = p.tel;
    out['p'+n+'_shirt'] = p.shirt;
  }
  out['RawJSON'] = JSON.stringify({
    phone:data.phone,email:data.email,team:data.team,agree:data.agree,players:data.players
  });

  disableButtons(true);
  try{
    const res = await fetch(BASEROW_API, {
      method:'POST',
      headers:{
        'Authorization':'Token ' + BASEROW_TOKEN,
        'Content-Type':'application/json'
      },
      body: JSON.stringify(out)
    });
    const result = await res.json().catch(()=>({}));
    if(!res.ok){
      throw new Error((result && (result.error || result.detail)) ? (result.error || result.detail) : ('HTTP '+res.status));
    }

    // ถือว่าสำเร็จ → เคลียร์และไปหน้า success
    localStorage.removeItem(storageKey);
    step=5; show('step5');
  }catch(err){
    alert('ส่งไม่สำเร็จ: ' + (err && err.message ? err.message : err));
  }finally{
    disableButtons(false);
  }
};

qs('restart').onclick = function(){
  localStorage.removeItem(storageKey);
  data = JSON.parse(JSON.stringify(init));
  step=1; pi=0; show('step1'); syncFromState();
};

function disableButtons(disabled){
  var btns = document.querySelectorAll('button');
  for(var i=0;i<btns.length;i++){ btns[i].disabled = !!disabled; }
}

/* ---------- init ---------- */
(function initUI(){
  // บังคับเฉพาะตัวเลขในช่องเบอร์
  qs('phone').addEventListener('input', function(e){ e.target.value = e.target.value.replace(/[^\\d]/g,''); });
  qs('pTel').addEventListener('input', function(e){ e.target.value = e.target.value.replace(/[^\\d]/g,''); });

  show('step1');
  syncFromState();
})();

/* =========================[ADD ONLY]========================= */
/* Modal PDF controller */
(function(){
  var backdrop = document.getElementById('pdfModalBackdrop');
  if(!backdrop) return;
  var frame = document.getElementById('pdfFrame');
  var openNewTab = document.getElementById('pdfOpenNewTab');
  var lastActive = null;

  window.pdfModalOpen = function(url, title){
    var t = document.getElementById('pdfModalTitle');
    if(t) t.textContent = title || 'PDF';
    frame.src = url;                               // ต้องเป็น /preview
    if(openNewTab) openNewTab.href = url.replace('/preview','/view');
    lastActive = document.activeElement;
    backdrop.style.display = 'flex';
    document.addEventListener('keydown', escClose, { once:true });
  };
  window.pdfModalClose = function(){
    backdrop.style.display = 'none';
    frame.src = '';
    if(lastActive && lastActive.focus) lastActive.focus();
  };
  function escClose(e){ if(e.key === 'Escape') window.pdfModalClose(); }
  backdrop.addEventListener('click', function(e){ if(e.target === backdrop) window.pdfModalClose(); });
})();

/* บังคับติ๊ก PDPA ก่อนกด SUBMIT ใน Step 1 (wrap handler เดิม) */
(function(){
  var btn = document.getElementById('next1');
  if(!btn) return;
  var original = btn.onclick;                  // เก็บ handler เดิม
  btn.onclick = function(){                    // wrap โดยไม่แก้ logic เดิม
    var ok = document.getElementById('agreePdpa') && document.getElementById('agreePdpa').checked;
    if(!ok){
      var err = document.getElementById('errAgreePdpa');
      if(err) err.classList.remove('hidden');
      return;
    }
    if(original) original();                   // ผ่านแล้วค่อยเรียกของเดิม
  };
})();

  // ใส่ต่อจากฟังก์ชั่น setBgFromVar() ที่ตั้ง src ให้ <img id="bg">
  (function fallbackBg(){
    const bg = document.getElementById('bg');
    // ถ้ารูปล้มเหลว → เอารูปออก และเติมพื้นหลังไล่สีให้ stage
    bg.onerror = function(){
      bg.remove();
      document.querySelector('.stage').style.background =
        'radial-gradient(1200px 600px at 50% -200px, #222 0%, #000 60%)';
    };
  })();

</script>
</body>
</html>
